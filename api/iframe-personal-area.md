<!-- TITLE: Интеграция Iframe в личный кабинет -->
<!-- SUBTITLE: Velvica бесшовно интегрируется в существующий личный кабинет, который организация предоставляет своим покупателям. Ниже приведён перечень действий по интеграции.-->
> Внимание: красным цветом отмечены места, в которых чаще всего обнаруживаются ошибки (по статистике нескольких десятков интеграций). Будьте особо внимательны при отладке «красных» пунктов. {.is-warning}

Каждый раздел документа – это следующий шаг при выполнении интеграции.
# Получить данные для интеграции
При регистрации оператор получает два уникальных значения:
* **$AG_NAME**: уникальное имя оператора (доменное имя сайта без точек и дефисов).
* **$AG_SECRET**: секретный ключ оператора (известен только оператору и администратору).
# Связать домен 3-го уровня с витриной
Витрина – это место, где пользователь может прочитать подробную информацию о продуктах и выбрать подходящий ему вариант. Авторизация на витрине отсутствует: при нажатии кнопки «Купить» пользователь всегда перенаправляется в Личный кабинет для совершения покупки** ~~(см. п. 3 ниже)~~.**
* Открыть `/var/named/*/*agent-name*` (файл зоны `agent-name.ru`) и прописать в него (**обратите внимание на точки в конце имен!**):
* `podpiska.agent-name.ru.  CNAME  <velvica_configured_showcase_domain>.`
* Выполнить `/etc/init.d/named reload`
# Разместить страницу с IFRAME в Личном кабинете
Оператору не требуется реализовывать в Личном кабинете логику подключения/отключения услуг, а также дорабатывать свой биллинг. Вся работа происходит внутри IFRAME, который работает в рамках платформы Velvica.
* Создать в Личном кабинете новую пустую страницу (например, по адресу `http://cabinet.agent-name.ru/podpiska/` – далее по тексту мы ссылаемся на нее просто как на `/podpiska/`). Вставить на страницу `/podpiska/` стандартную «шапку» и стандартный «подвал» Личного кабинета.
* Убедиться, что при прямом наборе в браузере URL `/podpiska/?any_arguments` вначале открывается форма авторизации абонента, а уже затем – отображается именно эта страница, с сохранением всех аргументов: `/podpiska/?any_arguments` – это важно для корректного сопряжения Личного кабинета с витриной. 
> Т.е. после авторизации абонент должен попадать ровно на тот же URL, на который он перешел изначально, с теми же аргументами!{.is-warning}
* Если личный кабинет не поддерживает сохранение URL-а после авторизации и с предыдущим пунктом возникают проблемы, обходной путь описан в файле `~~**embed_insert_iframe.txt.**~~`
* Вставить в середину страницы /podpiska/ тэг IFRAME, содержащий блок управления услугами Velvica. В src тэга IFRAME передаются: ID текущего пользователя, текущее время, цифровая подпись и т.д., а также данные для подстройки высоты IFRAME под высоту контента (~~**полное описание см. в конце документа**~~). Не пытайтесь генерировать IFRAME вручную – лучше возьмите за основу готовые примеры кода, приложенные к документу: файл api/Velvica.php, функция getIframe() (или, если у Вас не PHP, возьмите за основу JavaScript-код из функции getStretchingIframe()). Например, для PHP вызов данной функции может быть таким

```php
require_once "path/to/api/Velvica.php";
echo Velvica::getIframe(
    @$_GET['rs_uri'],
    null,
    "уникальное имя оператора ($AG_NAME)",
    "ID_ТЕКУЩЕГО_ЗАЛОГИНЕННОГО_ПОЛЬЗОВАТЕЛЯ",
    null,
    "Ключ цифровой подписи IFRAME ($AG_SECRET)"
); 
```

~~**В архиве с примерами кода имеются примеры метода getIframe() для PHP, Java Servlets, JSP, Perl, Ruby и C#.**~~
* Прописать в меню Личного кабинета ссылку на получившуюся страницу с IFRAME, чтобы пользователи могли туда переходить из Личного кабинета и управлять своими услугами (например, блокировать, отключать и т.д.).

# Реализовать API списания средств
Платформа Velvica присылает оператору запросы на разовые списания средств через API. Оператор может обрабатывать эти списания как разовые услуги. Необходимый перерасчет (при подключении ПО в середине расчетного периода) и периодичность списаний, подстроенную под биллинговый цикл оператора, обеспечивает сама платформа Velvica.
Для отладки реализации API используйте инструмент `http://$BO_DOMAIN/testapi201.html` где $BO_DOMAIN - домен бэк-офиса, в котором вы зарегистрированы на платформе Velvica (например, `bo.rentsoft.ru`).
## Создать скрипт `/podpiska/generic/api/`, 
Скрипт будет обрабатывать запросы списания средств. Входные данные принимаются методом POST. Выходные данные возвращаются в виде набора строк вида `ключ=значение<перевод_строки>`
> Убедиться, что скрипт доступен с IP-адресов кластера Velvica. Если прямой доступ невозможен, необходимо организовать проброс портов.
## Реализовать метод `getUserInfo()`
Получение информации о пользователе. На вход: массив uuid. На выход: массив структур `(uuid, periodStartDay, timeShift, amount, tariffId, isJuridical)`. Коды ответов: `OK, USER_UNKNOWN_UUID`. Здесь и далее код ответа должен выдаваться обязательно; не допускается пропуск в выдаче кода ответа для того или иного uuid.

```text
POST /podpiska/generic/api/?method=getUserInfo&apikey=4ktr832yur7 HTTP/1.1
Content-Length: ...
uuid0=1635276&uuid1=555&uuid2=27452645&uuid3=23245&…
```

**Ответ:**

```json
uuid0=1635276
periodStartDay0=5
timeShift0=4
amount0=10
tariffId0=101 202
isJuridical0=0
error0=OK
uuid1=555
periodStartDay1=1
timeShift1=4
amount1=50
tariffId1=56
isJuridical1=0
error1=OK
uuid2=27452645
error2=USER_UNKNOWN_UUID
...
```

~~**Подробное описание полей см. в конце документа.** ~~
Параметр `amount` (текущая сумма на счете абонента) не является обязательным, однако рекомендуем его выдавать, т.к. это значительно упрощает процедуру тестирования API, проводимую Velvica. Если у пользователя подключено сразу несколько тарифов, то в выходной переменной tariffId может быть несколько ID тарифов (или групп, или пакетов), разделенных пробелами (например, как в первом блоке ответа из примера).
## Реализовать метод `getUuidsByTariff()`
Получение информации о пользователях определенного тарифа, о котором провайдер и Velvica договариваются заранее (или списка пользователей, подключивших определенный пакет либо находящихся в определенной группе – зависит от терминологии провайдера). Метод используется при организации услуги "Комплексный тариф: интернет+антивирус", популярной у многих интернет-провайдеров. На вход: массив структур `(tariffId, from, to)`. На выход: массив структур `(tariffId, uuids, error)`, где uuids – длинный список UUID пользователей через пробел. Коды ответов: OK, USER_NO_SUCH_TARIFF.

```
POST /podpiska/generic/api/?method=getUuidsByTariff&apikey=4ktr832yur7 HTTP/1.1
Content-Length: ......
tariffId0=101&from0=1297092049&to0=1297178486&
tariffId1=102&from1=1297092049&to1=1297178486…………
```

**Ответ:**

```json
tariffId0=101
uuids0=12 37627 362 1836 33 21093 1236
error0=OK
tariffId1=102
uuids1=
error1=USER_NO_SUCH_TARIFF
```

где 
* `tariffId` – идентификатор тарифа в биллинге провайдера, 
* `from и to` (timestamp в формате unixtime) – временны́е границы даты подключения пользователя к данному тарифу. 
Допустимо также возвращать полный список пользователей на тарифе, игнорируя поля from и to – Velvica корректно отслеживает ситуацию, когда информация о пользователе уже была получена ранее. 
> Обратите особое внимание: метод информационный и не изменяет состояние на стороне провайдера. Т.е. если его вызвать несколько раз подряд с одними и теми же параметрами, он вернет один и тот же список, т.е. его действие не является "инкрементным" или "дифференциальным".
## Реализовать метод `canCharge()`
Проверка возможности списания средств. На вход: массив структур `(uuid, txid, amount)`. На выход: массив структур `(txid, error)`. Коды ответов: `OK, USER_UNKNOWN_UUID, USER_NO_MONEY.`

```
POST /podpiska/generic/api/?method=canCharge&apikey=4ktr832yur7  HTTP/1.1
Content-Length: ...
uuid0=163&txid0=e82a&amount0=59&
uuid1=341&txid1=nf71&amount1=89&
uuid2=555&txid2=ru46&amount2=89&
...
```

**Ответ:**

```json
txid0=e82a
error0=OK
txid1=nf71
error1=USER_NO_MONEY
txid2=ru46
error2=USER_UNKNOWN_UUID
...
```

> ВАЖНО: убедиться, что в методе canCharge() возвращается статус ответа OK в случае, если charge() с таким txid уже ранее запрашивался и списание на стороне провайдера было реально произведено (т.е. оператору необходимо хранить у себя все произведенные когда-либо операции charge. См. метод charge() и код ответа: USER_DUPLICATE_TXID).{.is-warning}
> ВАЖНО: canCharge() может принимать отрицательное значение в случае, если производится возврат средств пользователю на его счет.{.is-warning}
## Реализовать метод `charge()`
Списание средств. 
На вход: массив структур `(uuid, txid, amount, comment, periodEnd, serviceKey, serviceName, baseCost, subId)` – описание полей ~~**см. в конце документа**~~. На выход: массив структур `(txid, error)`. Коды ответов: `OK, USER_DUPLICATE_TXID, USER_UNKNOWN_UUID, USER_NO_MONEY`. Здесь и далее кодировка текста – UTF-8.

```text
POST /podpiska/generic/api/?method=charge&apikey=4ktr832yur7  HTTP/1.1
Content-Length: ...
uuid0=163&txid0=e82a&amount0=59&comment0=...&periodEnd0=2010-02-01&serviceKey0=drweb&serviceName0=Dr.Web Классик&baseCost0=100&subId0=131343&
uuid1=341&txid1=nf71&amount1=89&comment1=...&periodEnd0=2010-03-01&serviceKey1=nod32&serviceName0=ESET NOD32&baseCost1=100&subId1=3432&
uuid2=555&txid2=ru46&amount2=89&comment2=...&periodEnd0=2010-05-01&serviceKey2=panda&serviceName0=Panda Antivirus&baseCost2=100&subId2=34341&
...
```

**Ответ:**

```json
txid0=e82a
error0=OK
txid1=nf71
error1=USER_NO_MONEY
txid2=ru46
error2=USER_UNKNOWN_UUID
...
```

В поле comment содержится исчерпывающее человекочитаемое описание текущего списания, например: «Списание средств за антивирус Dr.Web Классик с перерасчетом за неполный расчетный период с 2018-01-26 до 2018-02-01».
> ВАЖНО: убедиться, что в методе charge() возвращается статус ответа USER_DUPLICATE_TXID в случае, если charge() с таким txid уже ранее запрашивался и списание на стороне провайдера было реально произведено (т.е. оператору необходимо хранить у себя все произведенные когда-либо операции charge):{.is-warning}

```json
POST /podpiska/generic/api/?method=charge&apikey=4ktr832yur7  HTTP/1.1
Content-Length: ...
uuid0=163&txid0=e82a&amount0=59&comment0=...&periodEnd0=2010-01-01&serviceKey0=drweb&serviceName0=Dr.Web Классик
Ответ:
txid0=e82a
error0=USER_DUPLICATE_TXID
```

> •	ВАЖНО: charge() может принимать отрицательное значение в случае, если производится возврат средств пользователю на его счет.{.is-warning}
## Учесть системные ошибки
В случае системной ошибки (недоступность БД у оператора, неверный формат запроса и т.д.) оператору рекомендуется выдавать подробную диагностику вместо ответа (т.е. любой текст, не похожий по формату на «ключ=значение<перевод_строки>»). В случае поломки API Velvica будет выдавать оператору именно данную информацию, так что чем больше подробностей – тем лучше. Вот три примера ответов при ошибке:

```json
Invalid APIKEY.
Unknown method.
System error: подробное отладочное описание ошибки.
```


# Реализовать дополнительные методы API (не обязательно)
## Метод `getUuidsWithIncreasedAmount()`
Для улучшения производительности и снижения нагрузки желательно, но не обязательно, реализовать метод getUuidsWithIncreasedAmount(): получение списка абонентов, которые пополняли счет в указанном промежутке времени. На вход:` (from, to)`. На выход: массив структур` (uuid, timestamp)`.

```text
POST /podpiska/generic/api/?method=getUuidsWithIncreasedAmount&apikey=4ktr832yur7 HTTP/1.1
Content-Length: ......
from=1297092049&to=1297178486
```

**Ответ:**

```json
uuid0=12
timestamp0=1297092050
uuid1=2345
timestamp1=1297092057
uuid2=3672
timestamp2=1297092060
...
```

* `from и to` (timestamp в формате unixtime) – временны́е границы диапазона, за который запрашиваются данные о пополнениях. Необходимо вернуть все без исключения uuid абонентов, у которых в промежуток времени от from до to включительно увеличивался баланс. В соответствующем выходном поле timestamp нужно вернуть точное время увеличения баланса, чтобы система знала, с какого момента запрашивать данные в следующий раз. Чаще всего данный метод реализуется сканированием таблицы payments на стороне провайдера и возвратом всех абонентов, у которых в payments имеются записи о пополнении баланса между from и to, т.е., например:

```sql
SELECT user_id, MAX(timestamp) FROM payments
WHERE timestamp BETWEEN $from AND $to 
GROUP BY user_id
```

> Обратите особое внимание: метод информационный и не изменяет состояние на стороне провайдера. Т.е. если его вызвать несколько раз подряд с одними и теми же параметрами, он вернет один и тот же список, т.е. его действие не является "инкрементным".{.is-warning}
## Метод `uncharge()`
Метод `uncharge()`: отмена предыдущего списания. Метод необязательный и вызывается исключительно в «ручном» режиме по согласованию с оператором (а также в процессе отладки интеграции). На вход: массив структур `(uuid, txid)`. На выход: массив структур `(txid, error)`. Коды ответов:` OK, USER_UNKNOWN_UUID, USER_UNKNOWN_TXID.`

```text
POST /podpiska/generic/api/?method=uncharge&apikey=4ktr832yur7  HTTP/1.1
Content-Length: ...
uuid0=163&txid0=e82a&uuid1=341&txid1=nf71&...
```

Ответ:

```json
txid0=e82a
error0=OK
txid2=ru46
error2=USER_UNKNOWN_TXID
...
```
## Метод `notifyStatusChange()`
`notifyStatusChange()`: уведомление оператора об изменении статуса услуги Velvica. Метод не обязателен и реализуется по желанию оператора. На вход: массив `(uuid, txid, status, serviceKey, serviceName, computerName, comment , subId)`. На выход: `(txid, error). Коды ответов: OK, USER_UNKNOWN_UUID.`

```json
POST /podpiska/generic/api/?method=notifyStatusChange&apikey=4ktr832yur7  HTTP/1.1
Content-Length: ...
uuid0=163&txid0=e82a&status=active&serviceKey0=drweb&serviceName0=Dr.Web Классик&computerName0=MyPc&comment0=Добровольная блокировка&subId0=13272
...
```

Ответ:

```json
txid0=e82a
error0=OK
txid1=nf71
error1=OK
txid2=ru46
error2=USER_UNKNOWN_UUID
...
```

> Обратите внимание, что поле txid здесь не имеет отношения к полю txid метода charge(); здесь это лишь идентификатор операции, для которого в ответе должна иметься пара (txid, error).
> Внимание: по умолчанию данный метод не вызывается после смены статуса какой-либо подписки. Для получения запросов notifyStatusChange() в сторону оператора необходимо обратиться в службу поддержки и сообщить о такой необходимости.{.is-warning}
## Метод `search()`
Поиск по базе данных оператора. Поскольку актуальная информация об абонентах есть только на стороне оператора, а интерфейс поиска располагается в системе Velvica, можно реализовать данный метод. Метод не обязателен и реализуется по желанию оператора. На вход: массив` (query)`. На выход:` (query, error, uuid, name)`. Коды ответов: OK (все, кроме ОК, будет восприниматься как ошибка).

```text
POST /podpiska/generic/api/?method=search&apikey=4ktr832yur7  HTTP/1.1
Content-Length: ...
query0=124133&query1=88889
...
```

**Ответ:**

```json
query0=124133
error0=OK
uuid0=123
name0=ООО "Ромашка"
query1=88889
error1=OK
uuid1=124
name1=КТВ Самара
...
```

> Обратите внимание, что поле query – это текст поискового запроса. Это может быть uuid, номер договора абонента на стороне оператора, почта пользователя и так далее. Поле name – это, например, название компании (для юридического лица) или ФИО (для физического).

# Описание полей и кодов ответов
* Поля, помеченные как необязательные, могут отсутствовать в запросах/ответах.
* Во всех запросах от Velvica к оператору будет передан параметр apikey (строка до 255 символов). Данный параметр известен только администратору Velvica и оператору и используется для ограничения доступа к API оператора. В качестве дополнительной степени защиты оператор может настроить прием запросов только из определенной подсети Velvica.
* Ответы на все описанные далее запросы должны содержать код ответа в поле error (ENUM). Допустимые варианты значения поля приведены в конце раздела. 
* Крайне желательно, чтобы оператор поддерживал массовые версии всех описанных в документации команд (включая команду search). То есть на вход команды (запрос) может подаваться не один набор параметров, а массив таких наборов. В этом случае в ответ на команду должен быть дан массив ответов такого же размера, что и переданный массив на вход. Код ответа (поле error) должен быть указан для каждого набора в отдельности. Максимально допустимое число входных наборов команды обсуждается с оператором отдельно. Далее описываются поля одного набора параметров, подразумевая возможность передачи массива наборов.


## Команды canCharge и charge
Поля запроса:
| Имя параметра| 	Тип данных	| Описание	| Обязат.| 
| ------------------ | ------------------| ------------------ | -------:|
|uuid	|Строка до 255 символов	|Уникальный идентификатор пользователя (может быть число, логин - все, что угодно, главное, чтобы у разных пользователей он был разным и никогда не менялся со временем).|	Да|
|txid	|Строка до 32 символов	|Идентификатор транзакции списания средств, уникальный для каждого списания.|	Да|
|amount	|Целое число	|Сколько денег списывается/проверяется со счета пользователя. Может быть равно 0, когда подписка подключается в триальный (тестовый) период: это допустимый случай, когда абонент, действительно, ничего не платит за подключение. Может принимать отрицательные значения в случае возврата средств пользователю.	|Да|
|comment	|Строка в UTF-8	|Человекочитаемый комментарий к транзакции.	|Да|
|serviceKey|	Строка в формате` ^[a-z0-9_]{1,64}$`|	Уникальный идентификатор («ключ») продукта; для каждого конкретного продукта неизменен.|	Да|
|serviceName|	Строка до 64 символов в UTF-8	|Название продукта на русском языке.|Да|
|periodStart|	Дата в формате `YYYY-MM-DD`	|Дата, с которой будет действовать текущее списание. Параметр дан в информационных целях.	|Да|
|periodEnd|	Дата в формате `YYYY-MM-DD`|	Дата, до которой будет действовать текущее списание. По истечение этой даты будет произведена попытка повторного списания средств для продолжения действия подписки. Параметр дан в информационных целях.	|Да|
|isNew	|Число 0 или 1	|Признак того, что производится списание за новую подписку.|	Да|
|computerName|	Строка до 64 символов|	Имя компьютера, которое пользователь может ввести при подключении подписки.| Параметр дан в информационных целях.	|Нет|
baseCost	Вещественное положительное число	Цена (в валюте) подписки за 1 полный расчетный период. Параметр дан в информационных целях.	Нет
subId	64-битное число	Внутренний идентификатор подписки на платформе Velvica. Параметр дан в информационных целях.	Нет
Поля ответа:
Имя параметра	Тип данных	Описание	Обязат.
txid	См. описание полей запроса команды.	Да

| Browser            | Version |
| ------------------ | -------:|
| Chrome             | L       |
| Firefox            | L       |
| Safari             | L       |
| Edge               | L       |
| Internet Explorer  | 11      |
| Opera              | L       |
| Chrome for mobile  | L       |
| Firefox for mobile | L       |
| Mobile Safari      | L       |
| Android Browser    | L       |
